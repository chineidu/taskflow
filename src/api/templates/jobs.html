<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-slate-100 font-sans p-6">

    <div class="max-w-2xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-black text-blue-500">TaskFlow</h1>
            <p class="text-slate-400">ML Task Orchestrator Demo</p>
        </header>

        <section class="bg-slate-800 p-6 rounded-xl shadow-2xl mb-8 border border-slate-700">
            <h2 class="text-xl font-bold mb-4">Submit New Job</h2>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-400 font-mono">
                        Request ID <span class="text-slate-600 text-xs">(Optional)</span>
                    </label>
                    <input type="text" id="request-id-input"
                        class="w-full p-3 bg-slate-900 rounded border border-slate-600 focus:border-blue-500 outline-none font-mono text-sm text-slate-300"
                        placeholder="Auto-generated">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-400 font-mono">
                        Idempotency Key <span class="text-slate-600 text-xs">(Optional)</span>
                    </label>
                    <input type="text" id="idempotency-input"
                        class="w-full p-3 bg-slate-900 rounded border border-slate-600 focus:border-blue-500 outline-none font-mono text-sm text-slate-300"
                        placeholder="Auto-generated">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-400 font-mono">Payload</label>
                    <textarea id="payload-input"
                        class="w-full p-4 bg-slate-900 rounded border border-slate-600 focus:border-blue-500 outline-none font-mono text-sm min-h-[400px] resize-y">{
  "task_type": "ml_inference",
  "queue_name": "task_queue",
  "data": [
    {"payload": {"image_url": "s3://rx/001.jpg", "model": "resnet50"}},
    {"payload": {"image_url": "s3://rx/002.jpg", "model": "resnet50"}}
  ]
}</textarea>
                </div>

                <button id="submit-btn" type="button"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold transition">
                    Dispatch to Workers
                </button>
            </div>
        </section>

        <section>
            <h3 class="text-sm font-semibold text-slate-500 uppercase mb-4">Live Updates</h3>
            <div id="task-container">
                <p class="text-slate-600 italic text-center">No tasks yet...</p>
            </div>
        </section>
    </div>

    <script>
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.addEventListener('load', function () {
            document.getElementById('submit-btn').addEventListener('click', async function () {
                try {
                    const payload = JSON.parse(document.getElementById("payload-input").value);
                    const requestId = document.getElementById("request-id-input").value.trim() || generateUUID();
                    const idempotencyKey = document.getElementById("idempotency-input").value.trim() || generateUUID();

                    const response = await fetch('/api/v1/jobs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Request-ID': requestId,
                            'Idempotency-Key': idempotencyKey
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('task-container').innerHTML =
                            '<div class="bg-green-900/50 border border-green-500 rounded p-4 mb-2 font-mono text-sm">âœ… Submitted ' + result.taskIds.length + ' tasks<pre class="text-xs mt-2 text-green-400">' + JSON.stringify(result, null, 2) + '</pre></div>' + document.getElementById('task-container').innerHTML;
                    } else {
                        alert('Error: ' + JSON.stringify(result));
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            });
        });
    </script>
</body>

</html>